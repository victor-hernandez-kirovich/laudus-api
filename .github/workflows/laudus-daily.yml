name: Laudus Balance Sheet Monthly Automation (Last Day Only)

on:
  # Ejecutar DIARIAMENTE a las 22:00 Chile (01:00 UTC)
  # Pero el workflow solo descargar√° datos si es el √∫ltimo d√≠a del mes
  # Horario verano (Sep-Abr): UTC-3 ‚Üí 22:00 CLT = 01:00 UTC
  # Horario invierno (Abr-Sep): UTC-4 ‚Üí 22:00 CLT = 02:00 UTC
  schedule:
    - cron: '0 1 * * *'  # Todos los d√≠as a las 01:00 UTC (verano Chile)
  
  # Permitir ejecuci√≥n manual desde GitHub UI
  workflow_dispatch:

jobs:
  fetch-balance-sheet:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 horas (para manejar endpoints lentos)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check if last day of month
        id: check_date
        run: |
          # Obtener fecha de hoy y ma√±ana
          TODAY=$(date +%Y-%m-%d)
          TOMORROW=$(date -d "+1 day" +%Y-%m-%d)
          TODAY_MONTH=$(date +%m)
          TOMORROW_MONTH=$(date -d "+1 day" +%m)
          TODAY_DAY=$(date +%d)
          
          echo "üìÖ Hoy: $TODAY (d√≠a $TODAY_DAY)"
          echo "üìÖ Ma√±ana: $TOMORROW"
          
          # Si el mes de ma√±ana es diferente, hoy es el √∫ltimo d√≠a del mes
          if [ "$TODAY_MONTH" != "$TOMORROW_MONTH" ]; then
            echo "is_last_day=true" >> $GITHUB_OUTPUT
            echo "target_date=$TODAY" >> $GITHUB_OUTPUT
            echo "‚úÖ HOY ES EL √öLTIMO D√çA DEL MES: $TODAY"
            echo "üöÄ Procediendo con la descarga de datos..."
          else
            echo "is_last_day=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  Hoy NO es el √∫ltimo d√≠a del mes: $TODAY"
            echo "üí§ Saltando descarga (los datos son acumulativos)"
          fi
      
      - name: Setup Python 3.13
        if: steps.check_date.outputs.is_last_day == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install dependencies
        if: steps.check_date.outputs.is_last_day == 'true'
        run: |
          pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Fetch Balance Sheet Data (Last Day of Month)
        if: steps.check_date.outputs.is_last_day == 'true'
        env:
          LAUDUS_API_URL: ${{ secrets.LAUDUS_API_URL }}
          LAUDUS_USERNAME: ${{ secrets.LAUDUS_USERNAME }}
          LAUDUS_PASSWORD: ${{ secrets.LAUDUS_PASSWORD }}
          LAUDUS_COMPANY_VAT: ${{ secrets.LAUDUS_COMPANY_VAT }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DATABASE: ${{ secrets.MONGODB_DATABASE }}
        run: |
          echo "üìä Descargando balances para: ${{ steps.check_date.outputs.target_date }}"
          python scripts/fetch_balancesheet.py
      
      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: laudus-logs-${{ github.run_number }}
          path: scripts/logs/
          retention-days: 30
