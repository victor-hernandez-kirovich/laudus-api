# üöÄ Configuraci√≥n de Render.com para Backfill Hist√≥rico

Este documento explica c√≥mo configurar Render.com para ejecutar autom√°ticamente el backfill de datos hist√≥ricos de Laudus (Enero-Septiembre 2025).

## üìã Tabla de Contenidos

1. [Crear Cuenta en Render](#1-crear-cuenta-en-render)
2. [Conectar Repositorio](#2-conectar-repositorio)
3. [Crear Cron Job](#3-crear-cron-job)
4. [Configurar Variables de Entorno](#4-configurar-variables-de-entorno)
5. [Verificar y Activar](#5-verificar-y-activar)
6. [Monitorear Ejecuciones](#6-monitorear-ejecuciones)
7. [Pausar/Eliminar despu√©s](#7-pausareliminar-despu√©s)
8. [Troubleshooting](#8-troubleshooting)

---

## 1. Crear Cuenta en Render

### Opci√≥n A: Con GitHub (Recomendado)

1. Ve a: https://render.com
2. Click en **"Get Started"** o **"Sign Up"**
3. Selecciona **"Sign up with GitHub"**
4. Autoriza a Render para acceder a tus repositorios
5. ‚úÖ Listo

### Opci√≥n B: Con Email

1. Ve a: https://render.com
2. Click en **"Get Started"**
3. Ingresa tu email y contrase√±a
4. Verifica tu email
5. Luego conecta tu cuenta de GitHub (Settings ‚Üí Account ‚Üí Connected Accounts)

**üí≥ ¬øSe requiere tarjeta de cr√©dito?**
- ‚ùå NO, el plan Free no requiere tarjeta
- ‚úÖ Todo es completamente gratis

---

## 2. Conectar Repositorio

1. En el Dashboard de Render, click en **"New +"** (esquina superior derecha)
2. Selecciona **"Cron Job"**
3. Click en **"Connect a repository"**
4. Busca y selecciona: **`victor-hernandez-kirovich/laudus-api`**
5. Click en **"Connect"**

**Si el repositorio no aparece:**
- Click en **"Configure account"** (link azul)
- Esto te lleva a GitHub
- Selecciona los repositorios que quieres que Render pueda ver
- Marca: `laudus-api`
- Guarda cambios
- Regresa a Render y refresca la p√°gina

---

## 3. Crear Cron Job

### Paso 3.1: Informaci√≥n B√°sica

Despu√©s de conectar el repo, ver√°s un formulario:

1. **Name**: `laudus-backfill-ene-sep` (o el nombre que prefieras)
2. **Region**: `Oregon (US West)` (recomendado, m√°s cercano a Chile)
3. **Branch**: `main`
4. **Root Directory**: Dejar en blanco o poner `.`

### Paso 3.2: Build & Start Commands

Render deber√≠a detectar autom√°ticamente el archivo `render.yaml`. Si no:

**Build Command:**
```bash
pip install --upgrade pip && pip install -r scripts/requirements.txt
```

**Start Command:**
```bash
python scripts/fetch_balancesheet_backfill.py
```

### Paso 3.3: Schedule

1. **Schedule**: `0 2 * * *`
   - Esto es **23:00 hora Chile** (UTC-3)
   - En UTC es 02:00
   
2. O usa la interfaz gr√°fica:
   - **Frequency**: Daily
   - **Hour**: 02 (UTC)
   - **Minute**: 00

### Paso 3.4: Plan

1. Selecciona: **Free** (debe estar preseleccionado)
2. **Environment**: Python 3

---

## 4. Configurar Variables de Entorno

Esta es la parte m√°s importante. Necesitas configurar las variables secretas.

### Paso 4.1: Ir a Environment Variables

1. En la configuraci√≥n del Cron Job, busca la secci√≥n **"Environment"**
2. Click en **"Add Environment Variable"** o edita las existentes

### Paso 4.2: Configurar Variables Secretas

Agrega las siguientes variables **SECRETAS** (click en el √≠cono del ojo para ocultarlas):

#### Variable 1: LAUDUS_PASSWORD
```
Key: LAUDUS_PASSWORD
Value: [tu_password_de_laudus]
üîí Marca como "Secret"
```

#### Variable 2: LAUDUS_COMPANY_VAT
```
Key: LAUDUS_COMPANY_VAT
Value: [tu_rut_empresa]
üîí Marca como "Secret"
```

#### Variable 3: MONGODB_URI
```
Key: MONGODB_URI
Value: [tu_mongodb_connection_string]
üîí Marca como "Secret"
Ejemplo: mongodb+srv://usuario:password@cluster.mongodb.net/?retryWrites=true&w=majority
```

### Paso 4.3: Variables P√∫blicas (ya est√°n en render.yaml)

Estas deber√≠an aparecer autom√°ticamente desde el `render.yaml`:

```
LAUDUS_API_URL = https://api.laudus.cl
LAUDUS_USERNAME = API
MONGODB_DATABASE = laudus_data
BACKFILL_START_DATE = 2025-01-01
BACKFILL_END_DATE = 2025-09-30
BACKFILL_MODE = monthly
MAX_DATES_PER_RUN = 31
PYTHONUNBUFFERED = 1
```

Si no aparecen, agr√©galas manualmente.

---

## 5. Verificar y Activar

### Paso 5.1: Revisar Configuraci√≥n

Antes de crear el Cron Job, verifica:

‚úÖ Build Command: `pip install --upgrade pip && pip install -r scripts/requirements.txt`
‚úÖ Start Command: `python scripts/fetch_balancesheet_backfill.py`
‚úÖ Schedule: `0 2 * * *` (23:00 CLT)
‚úÖ Plan: Free
‚úÖ Variables secretas configuradas

### Paso 5.2: Crear Cron Job

1. Click en **"Create Cron Job"** (bot√≥n al final del formulario)
2. Render comenzar√° a configurar el servicio
3. Espera unos segundos...

### Paso 5.3: Primera Ejecuci√≥n (Opcional)

Para probar que todo funciona SIN esperar al horario programado:

1. Ve al Dashboard del Cron Job
2. Click en **"Trigger Run"** (bot√≥n manual)
3. Se ejecutar√° inmediatamente
4. Ve a la pesta√±a **"Logs"** para ver el progreso en tiempo real

---

## 6. Monitorear Ejecuciones

### Ver Logs en Tiempo Real

1. En el Dashboard del Cron Job
2. Click en la pesta√±a **"Logs"**
3. Ver√°s la salida del script en vivo

**Logs esperados:**

```
======================================================================
  LAUDUS BACKFILL - RENDER.COM
  Procesamiento Hist√≥rico: Enero-Septiembre 2025
======================================================================
Inicio: 2025-10-28 23:00:15
Rango: 2025-01-01 a 2025-09-30
Modo: monthly

üîê Autenticando con Laudus API...
‚úÖ Autenticaci√≥n exitosa
üîå Conectando a MongoDB Atlas...
‚úÖ Conexi√≥n a MongoDB exitosa

üîç Buscando meses pendientes...
üìä Meses pendientes: 9
   2025-01, 2025-02, 2025-03, 2025-04, 2025-05, 2025-06, 2025-07, 2025-08, 2025-09

======================================================================
  üìÖ PROCESANDO MES: 2025-01
======================================================================

üìÜ Fechas a procesar: 31
   Desde: 2025-01-01
   Hasta: 2025-01-31

--- Fecha 1/31 ---
üìÖ Procesando fecha: 2025-01-01
   üîÑ totals (intento 1/3)
   ‚úÖ totals: 1247 registros obtenidos
   ‚úÖ totals guardado (1247 registros)
   ‚è≥ Esperando 120s...
   üîÑ standard (intento 1/3)
   ‚úÖ standard: 856 registros obtenidos
   ‚úÖ standard guardado (856 registros)
   ...
```

### Ver Historial de Ejecuciones

1. En el Dashboard del Cron Job
2. Pesta√±a **"Events"**
3. Ver√°s todas las ejecuciones:
   - ‚úÖ Verde: Exitosa
   - ‚ùå Rojo: Fallida
   - üîµ Azul: En progreso

### Pr√≥ximas Ejecuciones Programadas

En el Dashboard ver√°s:
```
Next scheduled run: Oct 29, 2025 at 02:00 UTC (Oct 28, 23:00 CLT)
```

---

## 7. Pausar/Eliminar Despu√©s

### Cuando el Backfill est√© completo (d√≠a 9-10)

Ver√°s en los logs:
```
======================================================================
  üéâ ¬°BACKFILL COMPLETO!
======================================================================
‚úÖ Todos los meses est√°n completos en MongoDB
üìå Puedes PAUSAR o ELIMINAR este Cron Job en Render.com
======================================================================
```

### Opci√≥n A: Pausar el Cron Job

1. Dashboard del Cron Job
2. Click en **"Settings"** (pesta√±a)
3. Busca **"Suspend Cron Job"**
4. Click en **"Suspend"**
5. El job queda pausado (no se ejecuta, pero puedes reactivarlo despu√©s)

### Opci√≥n B: Eliminar el Cron Job

1. Dashboard del Cron Job
2. Click en **"Settings"** (pesta√±a)
3. Scroll hasta el final
4. Click en **"Delete Cron Job"**
5. Confirma la eliminaci√≥n
6. ‚úÖ El job desaparece completamente

**üí° Recomendaci√≥n:**
- **Pausar** si crees que podr√≠as necesitarlo de nuevo
- **Eliminar** si est√°s seguro que no lo necesitar√°s m√°s

---

## 8. Troubleshooting

### ‚ùå Error: "Authentication failed"

**Causa:** Credenciales incorrectas

**Soluci√≥n:**
1. Ve a **Environment Variables**
2. Verifica que `LAUDUS_PASSWORD` y `LAUDUS_COMPANY_VAT` sean correctos
3. Edita las variables si es necesario
4. Guarda cambios
5. Trigger manual run para probar

---

### ‚ùå Error: "MongoDB connection failed"

**Causa:** URI de MongoDB incorrecto o red

**Soluci√≥n:**
1. Verifica que `MONGODB_URI` est√© correcto
2. Formato debe ser: `mongodb+srv://usuario:password@cluster.mongodb.net/...`
3. Verifica que tu cluster de MongoDB Atlas:
   - Est√© activo
   - Permita conexiones desde **cualquier IP** (`0.0.0.0/0`) o espec√≠ficamente desde IPs de Render
4. En MongoDB Atlas ‚Üí Network Access ‚Üí Add IP Address ‚Üí Allow Access from Anywhere

---

### ‚è±Ô∏è Error: "Timeout"

**Causa:** Endpoint de Laudus tarda mucho

**Soluci√≥n:**
- El script tiene reintentos autom√°ticos (3 intentos por endpoint)
- Espera a que termine la ejecuci√≥n
- En la siguiente ejecuci√≥n diaria, continuar√° desde donde qued√≥

---

### üîÑ El Cron Job no se ejecuta a la hora programada

**Causa:** Timezone confusi√≥n

**Soluci√≥n:**
1. Verifica el schedule: `0 2 * * *` es **02:00 UTC** = **23:00 CLT** (horario verano Chile)
2. Si est√°s en horario invierno (UTC-4), ajusta a: `0 3 * * *`
3. Settings ‚Üí Edit schedule

---

### üìä ¬øC√≥mo saber qu√© meses ya est√°n completos?

**Opci√≥n 1:** Revisar los logs de la √∫ltima ejecuci√≥n

Busca la secci√≥n:
```
üìä Meses pendientes: 5
   2025-05, 2025-06, 2025-07, 2025-08, 2025-09
```

**Opci√≥n 2:** Consultar MongoDB directamente

Con√©ctate a MongoDB Atlas y verifica las colecciones:
- `balance_totals`
- `balance_standard`
- `balance_8columns`

Busca documentos con fechas entre `2025-01-01` y `2025-09-30`.

---

### üö® El script falla constantemente

**Pasos de diagn√≥stico:**

1. **Revisar logs completos:**
   - Ve a la pesta√±a "Logs"
   - Busca mensajes de error espec√≠ficos

2. **Verificar variables de entorno:**
   - Todas las variables secretas est√°n configuradas
   - No hay typos en los nombres de las variables

3. **Probar conexiones:**
   - MongoDB Atlas est√° activo y accesible
   - API de Laudus est√° disponible

4. **Contactar soporte:**
   - Si todo falla, puedes contactar soporte de Render (tienen chat)
   - O revisar el repositorio de GitHub para issues

---

## üìÖ Timeline Esperado

```
D√≠a 1 (28-Oct 23:00): Procesa Enero 2025   ‚úÖ
D√≠a 2 (29-Oct 23:00): Procesa Febrero 2025 ‚úÖ
D√≠a 3 (30-Oct 23:00): Procesa Marzo 2025   ‚úÖ
D√≠a 4 (31-Oct 23:00): Procesa Abril 2025   ‚úÖ
D√≠a 5 (01-Nov 23:00): Procesa Mayo 2025    ‚úÖ
D√≠a 6 (02-Nov 23:00): Procesa Junio 2025   ‚úÖ
D√≠a 7 (03-Nov 23:00): Procesa Julio 2025   ‚úÖ
D√≠a 8 (04-Nov 23:00): Procesa Agosto 2025  ‚úÖ
D√≠a 9 (05-Nov 23:00): Procesa Septiembre 2025 ‚úÖ
D√≠a 10 (06-Nov 23:00): Confirma todo completo üéâ
```

**Total: 9-10 d√≠as para completar Enero-Septiembre 2025**

---

## ‚úÖ Checklist Final

Antes de activar el Cron Job, verifica:

- [ ] Cuenta en Render.com creada
- [ ] Repositorio `laudus-api` conectado
- [ ] Cron Job creado con nombre claro
- [ ] Schedule configurado: `0 2 * * *`
- [ ] Variable `LAUDUS_PASSWORD` configurada (secreta)
- [ ] Variable `LAUDUS_COMPANY_VAT` configurada (secreta)
- [ ] Variable `MONGODB_URI` configurada (secreta)
- [ ] Variables p√∫blicas est√°n correctas
- [ ] Primera ejecuci√≥n manual probada (opcional)
- [ ] Logs muestran autenticaci√≥n exitosa
- [ ] Logs muestran conexi√≥n a MongoDB exitosa

---

## üéØ Resultado Final

Al completar esta configuraci√≥n:

‚úÖ Render ejecutar√° autom√°ticamente el backfill diariamente a las 23:00 (Chile)
‚úÖ Procesar√° un mes completo por d√≠a
‚úÖ En 9 d√≠as tendr√°s todos los datos de Enero-Septiembre 2025
‚úÖ El script se auto-detecta cuando termina
‚úÖ Puedes pausar/eliminar el Cron Job despu√©s

---

## üìû Soporte

- **Render Docs:** https://render.com/docs/cron-jobs
- **Render Community:** https://community.render.com
- **GitHub Issues:** [Crear issue en el repo]

---

**¬°Buena suerte con el backfill!** üöÄ
